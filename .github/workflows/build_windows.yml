name: Windows Build & Package

on:
  push:
    branches: [ main, dev ]
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.12"
  PYINSTALLER_VERSION: "6.7.0"
  PROJECT_NAME: "HornetNestLocator"
  EXE_NAME: "hornet-nest-locator"

jobs:
  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: true
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        cache-dependency-path: '**/setup.py'
    
    - name: Install system dependencies
      run: |
        choco install -y wget
        wget https://www.python.org/ftp/python/${{ env.PYTHON_VERSION }}/python-${{ env.PYTHON_VERSION }}-embed-amd64.zip -OutFile python-embed.zip
        Expand-Archive python-embed.zip -DestinationPath python-embed
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pyinstaller==${{ env.PYINSTALLER_VERSION }}
        pip install -e .
        pip install -r requirements.txt
    
    - name: Run unit tests
      run: |
        python -m pytest tests/ -v --tb=short
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Tests failed!"
          exit 1
        }
    
    - name: Create version info file
      run: |
        $version = "${{ github.ref_name }}"
        if ($version -match '^v\d+\.\d+\.\d+$') {
            $version = $version -replace '^v'
        } else {
            $version = "0.0.0-dev"
        }
        
        @"
[version]
version=$version
company=Hornet Nest Locator Team
product=Hornet Nest Locator
name=hornet-nest-locator
"@ | Out-File version.txt
        
        echo "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Append
    
    - name: Build Windows executable with PyInstaller
      run: |
        $pyinstallerArgs = @(
          "--clean",
          "--onefile",
          "--windowed",
          "--name", "${{ env.EXE_NAME }}",
          "--distpath=dist",
          "--workpath=build",
          "gui.py"
        )
        
        # Add icon if it exists
        if (Test-Path "assets/icon.ico") {
          $pyinstallerArgs += "--icon=assets/icon.ico"
        }
        
        # Add data files if they exist
        if (Test-Path "src/vespa_finder") {
          $pyinstallerArgs += "--add-data", "src/vespa_finder:vespa_finder"
        }
        if (Test-Path "assets") {
          $pyinstallerArgs += "--add-data", "assets/*:assets"
        }
        
        # Add version file if it exists
        if (Test-Path "version.txt") {
          $pyinstallerArgs += "--version-file=version.txt"
        }
        
        pyinstaller @pyinstallerArgs
        
        if (-not (Test-Path "dist/${{ env.EXE_NAME }}.exe")) {
          Write-Error "Executable build failed!"
          exit 1
        }
    
    - name: Create portable ZIP package
      run: |
        $outputDir = "dist/portable"
        New-Item -ItemType Directory -Path $outputDir -Force
        
        # Copy executable (must exist)
        if (-not (Test-Path "dist/${{ env.EXE_NAME }}.exe")) {
          Write-Error "Executable not found for portable package!"
          exit 1
        }
        Copy-Item "dist/${{ env.EXE_NAME }}.exe" "$outputDir/"
        
        # Copy assets if they exist
        if (Test-Path "assets") {
          Copy-Item -Path "assets/*" -Destination "$outputDir/" -Recurse -ErrorAction SilentlyContinue
        }
        
        # Copy documentation if it exists
        if (Test-Path "docs/GUI_GUIDE.md") {
          Copy-Item -Path "docs/GUI_GUIDE.md" -Destination "$outputDir/" -ErrorAction SilentlyContinue
        }
        if (Test-Path "README.md") {
          Copy-Item -Path "README.md" -Destination "$outputDir/" -ErrorAction SilentlyContinue
        }
        
        # Create launch script
        @"
@echo off
start "" "${{ env.EXE_NAME }}.exe"
"@ | Out-File "$outputDir/launch.bat"
        
        # Create ZIP archive
        Compress-Archive -Path "$outputDir/*" -DestinationPath "dist/${{ env.EXE_NAME }}-portable-windows.zip" -Force
        
        Write-Host "✅ Portable package created: dist/${{ env.EXE_NAME }}-portable-windows.zip"
    
    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: dist/${{ env.EXE_NAME }}.exe
        retention-days: 7
    
    - name: Upload portable package
      uses: actions/upload-artifact@v4
      with:
        name: windows-portable-package
        path: dist/${{ env.EXE_NAME }}-portable-windows.zip
        retention-days: 7
    
    - name: Create GitHub Release (on tags)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          dist/${{ env.EXE_NAME }}.exe
          dist/${{ env.EXE_NAME }}-portable-windows.zip
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-package:
    name: Test Windows Package
    needs: build-windows
    runs-on: windows-latest
    
    steps:
    - name: Download Windows executable
      uses: actions/download-artifact@v4
      with:
        name: windows-executable
        path: dist/
    
    - name: Download portable package
      uses: actions/download-artifact@v4
      with:
        name: windows-portable-package
        path: dist/
    
    - name: Verify executable exists and is valid
      run: |
        if (-not (Test-Path "dist/${{ env.EXE_NAME }}.exe")) {
          Write-Error "Executable not found!"
          exit 1
        }
        
        $fileInfo = Get-Item "dist/${{ env.EXE_NAME }}.exe"
        Write-Host "✅ Executable size: $($fileInfo.Length / 1MB) MB"
        
        # Check if it's a valid PE file
        $header = Get-Content -Path "dist/${{ env.EXE_NAME }}.exe" -Encoding Byte -TotalCount 2
        if ($header[0] -ne 0x4D -or $header[1] -ne 0x5A) {
          Write-Error "Invalid PE file (MZ signature missing)!"
          exit 1
        }
        Write-Host "✅ Valid PE file format"
    
    - name: Verify portable package
      run: |
        if (-not (Test-Path "dist/${{ env.EXE_NAME }}-portable-windows.zip")) {
          Write-Error "Portable package not found!"
          exit 1
        }
        
        $zipInfo = Get-Item "dist/${{ env.EXE_NAME }}-portable-windows.zip"
        Write-Host "✅ Portable package size: $($zipInfo.Length / 1MB) MB"
        
        # Extract and verify contents
        Expand-Archive -Path "dist/${{ env.EXE_NAME }}-portable-windows.zip" -DestinationPath "test-extract" -Force
        
        $requiredFiles = @(
          "${{ env.EXE_NAME }}.exe",
          "launch.bat",
          "GUI_GUIDE.md",
          "README.md"
        )
        
        foreach ($file in $requiredFiles) {
          if (-not (Test-Path "test-extract/$file")) {
            Write-Error "Missing required file: $file"
            exit 1
          }
          Write-Host "✅ Found: $file"
        }
